---
title: Reference Architecture for Pivotal Cloud Foundry on GCP
owner: Customer0
---

<strong><%= modified_date %></strong>

This guide presents a reference architecture for Pivotal Cloud Foundry (PCF) on Google Cloud Platform (GCP). This document also outlines multiple networking solutions. All these architectures are validated for production-grade PCF deployments using multiple (3+) AZs. 

See [GCP on PCF Requirements](../../customizing/gcp.html) for general requirements for running PCF and specific requirements for running PCF on GCP.


## <a id="refarchs"></a> PCF Reference Architectures

A PCF reference architecture describes a proven approach for deploying Pivotal Cloud Foundry on a specific IaaS, such as GC, that meets the following requirements:

* Secure
* Publicly-accessible
* Includes common PCF-managed services such as MySQL, RabbitMQ, and Spring Cloud Services
* Can host at least 100 app instances, or far more

Pivotal provides reference architectures to help you determine the best configuration for your PCF deployment.


## <a id="arch_diagram"></a> Base GCP Reference Architecture 

The following diagram provides an overview of a reference architecture deployment of PCF on GCP.

<%= image_tag('gcp-overview-arch.png') %>

[View a larger version of this diagram](../images/gcp-overview-arch.png).

### <a id="base_components"></a> Base Reference Architecture Components

The following table lists the components that are part of a reference architecture deployment with three availability zones.

|**Component**| **Reference Architecture Notes**|
|--------------------|------------|
|**Domains & DNS** | CF Domain Zones and routes in use by the reference architecture include: domains for *.apps and *.system (required), a route for Ops Manager (required), a route for doppler (required), a route for Loggregator (required), a route for ssh access to app containers (optional) and a route for TCP routing to apps (optional). Reference architecture uses GCP Cloud DNS as the DNS provider. |
|**Ops Manager**| Deployed on the infrastructure subnet and accessible by FQDN or through an optional jumpbox. |
|**BOSH Director** | Deployed on the infrastructure subnet. |
|**Gorouters**| Accessed through the regional TCP load balancers. Deployed on the Pivotal Application Service (PAS) subnet, one job per availability zone. | 
|**Diego Brains**| Required. However, the SSH container access functionality is optional and enabled through the SSH Proxy load balancer. Deployed on the PAS subnet, one job per availability zone. |
|**TCP Routers** | Optional feature for TCP routing. Deployed on the PAS subnet, one job per availability zone.|
|**CF Database**| Reference architecture uses GCP Cloud SQL rather than internal databases. Configure your database with a strong password and limit access only to components that require database access. |
|**CF Blob Storage and Buckets** | For buildpacks, droplets, packages and resources. Reference architecture uses Google Cloud Storage rather than internal file storage. |
|**Services**|Deployed on the PCF managed services subnet. Each service is deployed to each availability zone. |


## <a id="common_network"></a> Alternative GCP Network Layouts for PCF

This section describes the possible network layouts for PCF deployments as covered by the reference architecture of PCF on GCP. 

At a high level, there are currently two possible ways of granting public Internet access to PCF as described by the reference architecture:

* NATs provide public access to PCF internals.
	* The instructions for [Installing PCF on GCP Manually](../../customizing/gcp-manual.html) use this method. 
* Every PCF VM receives its own public IP address (no NAT).
	* The instructions for [Installing PCF on GCP using Terraform](../../customizing/gcp-terraform.html) use this method.

Providing each PCF VM with a public IP address is the most recommended architecture, because of increased latency due to NATs as well as extra maintenance required for NAT instances that cannot be deployed with BOSH. 

However, if you require NATs, you may refer to the following section.

### <a id="nat_network_diagram"></a> NAT-based Solution

This diagram illustrates the case where you want to expose only a minimal number of public IP addresses.

<%= image_tag('gcp-net-topology-base.png') %>

[View a larger version of this diagram](https://raw.githubusercontent.com/pivotal-cf/docs-pcf-refarch/master/images/gcp-net-topology-base.png).

### <a id="no_nat"></a> Public IP addresses Solution

If you prefer not to use a NAT solution, you can configure PCF on GCP to assign public IP addresses for all components. This type of deployment may be more performant since most of the network traffic between Cloud Foundry components are routed through the front end load balancer and the Gorouter.

### <a id="network_components"></a> Network Objects

The following table lists the network objects expected for each type of reference architecture deployment with three availability zones (assumes you are using NATs).

|**Network Object**| **Notes**| **Minimum Number: NAT-based** | **Minimum Number: Public IP Addresses**|
|--------------------|------------|----------------------|---------------------------|
| **External IPs** | For a NAT solution, use global IP address for apps and system access, and Ops Manager or optional jumpbox | 2 | 30+ |
| **NATs** | One NAT per availability zone. | 3 | 0 |
| **Network** | One per deployment. GCP Network objects allow multiple subnets with multiple CIDRs, so a typical deployment of PCF will likely only ever require one GCP Network object | 1 | 1 |
| **Subnets** | Separate subnets for infrastructure (Ops Manager, BOSH Director, Jumpbox), PAS, and services. Using separate subnets allows you to configure different firewall rules due to your needs. | 3 | 3 |
| **Routes** | Routes are typically created by GCP dynamically when subnets are created, but you may need to create additional routes to force outbound communication to dedicated SNAT nodes. These objects are required to deploy PCF without public IP addresses. | 3+ | 3|
| **Firewall Rules** | GCP firewall rules are bound to a Network object and can be created to use IP ranges, subnets, or instance tags to match for source & destination fields in a rule. The preferred method use in the reference architecture deployment is instance tags. | 6+ | 6+ |
| **Load balancers**| Used to handle requests to Gorouters and infrastructure components. GCP uses two or more load balancers. The TCP Router load balancer used for TCP routing feature and the SSH load balancer that allows SSH access to Diego apps are both optional. The regional TCP load balancer provides SSL termination. | 2+ | 2+ |
| **Jumpbox** | Optional. Provides a way of accessing different network components. For example, you can configure it with your own permissions and then set it up to access to Pivotal Network to download tiles. Using a jumpbox is particularly useful in IaaSes where Ops Manager does not have a public IP address. In these cases, you can SSH into Ops Manager or any other component through the jumpbox. | (1) | (1)|

### <a id="network_comm"></a> Network Communication in GCP Deployments

This section provides more background on the reasons behind certain network configuration decisions, specifically for the Gorouter.

#### Load Balancer to Gorouter Communications and TLS Termination

In a PCF on GCP deployment, the Gorouter receives both unencrypted TCP traffic and encrypted secure web socket traffic on port 80/443 that are decrypted by the regional TCP load balancer.

TLS is terminated for TCP traffic on the regional TCP load balancer and is terminated for WebSockets (WSS) traffic on the Gorouter.

#### ICMP

GCP routers do not respond ICMP; therefore, Pivotal recommends disabling ICMP checks in [BOSH Director network configuration](../../customizing/gcp-om-config.html#network). 